{% extends "base.html" %}

{% block title %}FIST Admin - Settings{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-gear"></i> Admin Settings</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
{% if success %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle"></i> {{ success }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if request.query_params.get('success') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle"></i> {{ request.query_params.get('success') }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if request.query_params.get('error') %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle"></i> {{ request.query_params.get('error') }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- System Configuration Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sliders"></i> System Configuration</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/admin/config">
                    <div class="row">
                        <!-- Content Piercing Configuration -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Content Piercing Settings</h6>
                            <div class="mb-3">
                                <label for="percentages" class="form-label">Percentages</label>
                                <input type="text" class="form-control" id="percentages" name="percentages"
                                       value="{{ config.percentages|join(', ') }}" required>
                                <div class="form-text">
                                    Comma-separated percentages (0-1) for different content lengths.
                                    Example: 0.8, 0.6, 0.4, 0.2
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="thresholds" class="form-label">Word Count Thresholds</label>
                                <input type="text" class="form-control" id="thresholds" name="thresholds"
                                       value="{{ config.thresholds|join(', ') }}" required>
                                <div class="form-text">
                                    Comma-separated word count thresholds.
                                    Example: 500, 1000, 3000
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <strong>How it works:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>&lt; 500 words: {{ "%.0f"|format(config.percentages[0] * 100) }}% of content</li>
                                    <li>500-1000 words: {{ "%.0f"|format(config.percentages[1] * 100) }}% of content</li>
                                    <li>1000-3000 words: {{ "%.0f"|format(config.percentages[2] * 100) }}% of content</li>
                                    <li>&gt; 3000 words: {{ "%.0f"|format(config.percentages[3] * 100) }}% of content</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Decision Thresholds -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Decision Thresholds</h6>
                            <div class="mb-3">
                                <label for="low_threshold" class="form-label">Low Threshold (%)</label>
                                <input type="number" class="form-control" id="low_threshold" name="low_threshold"
                                       value="{{ config.probability_thresholds.low }}" min="0" max="100" required>
                                <div class="form-text">
                                    Content with probability ≤ this value will be <strong class="text-success">approved</strong>.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="high_threshold" class="form-label">High Threshold (%)</label>
                                <input type="number" class="form-control" id="high_threshold" name="high_threshold"
                                       value="{{ config.probability_thresholds.high }}" min="0" max="100" required>
                                <div class="form-text">
                                    Content with probability &gt; this value will be <strong class="text-danger">rejected</strong>.
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <strong>Decision Logic:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>≤ {{ config.probability_thresholds.low }}%: <span class="badge bg-success">Approved</span></li>
                                    <li>{{ config.probability_thresholds.low + 1 }}% - {{ config.probability_thresholds.high }}%: <span class="badge bg-warning">Manual Review</span></li>
                                    <li>&gt; {{ config.probability_thresholds.high }}%: <span class="badge bg-danger">Rejected</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- AI Model Configuration -->
                        <div class="col-md-8">
                            <h6 class="text-primary mb-3">AI Model Settings</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ai_base_url" class="form-label">AI API Base URL</label>
                                        <input type="url" class="form-control" id="ai_base_url" name="ai_base_url"
                                               value="{{ config.ai_base_url }}" required>
                                        <div class="form-text">
                                            Base URL for the AI API endpoint (e.g., https://api.deepseek.com)
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ai_api_key" class="form-label">AI API Key</label>
                                        <input type="password" class="form-control" id="ai_api_key" name="ai_api_key"
                                               value="{{ config.ai_api_key }}" required>
                                        <div class="form-text">
                                            API key for authentication with the AI service
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ai_model" class="form-label">AI Model</label>
                                        <select class="form-select" id="ai_model" name="ai_model" required>
                                            <option value="deepseek-chat" {% if config.ai_model == 'deepseek-chat' %}selected{% endif %}>
                                                DeepSeek Chat
                                            </option>
                                            <option value="deepseek-coder" {% if config.ai_model == 'deepseek-coder' %}selected{% endif %}>
                                                DeepSeek Coder
                                            </option>
                                            <option value="gpt-3.5-turbo" {% if config.ai_model == 'gpt-3.5-turbo' %}selected{% endif %}>
                                                GPT-3.5 Turbo
                                            </option>
                                            <option value="gpt-4" {% if config.ai_model == 'gpt-4' %}selected{% endif %}>
                                                GPT-4
                                            </option>
                                        </select>
                                        <div class="form-text">
                                            Select the AI model to use for content moderation.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="max_users" class="form-label">Maximum Users</label>
                                        <input type="number" class="form-control" id="max_users" name="max_users"
                                               value="{{ config.max_users }}" min="1" max="10000" required>
                                        <div class="form-text">
                                            Maximum number of users allowed to register in the system.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Status -->
                        <div class="col-md-4">
                            <h6 class="text-primary mb-3">Configuration Status</h6>
                            <div class="alert alert-info">
                                <strong>Current Status:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Model: {{ config.ai_model }}</li>
                                    <li>API: {% if config.ai_api_key %}Configured{% else %}Not Set{% endif %}</li>
                                    <li>Users: {{ current_user_count }}/{{ config.max_users }}</li>
                                    <li>Available: {{ config.max_users - current_user_count }} slots</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Save Configuration Button -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- User Management Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people"></i> User Management</h5>
            </div>
            <div class="card-body">
                <!-- User Statistics -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card card-stats border-left-primary h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Total Users
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ user_count }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card card-stats border-left-info h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                            User Limit
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ max_users }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-person-check text-info" style="font-size: 2rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card card-stats border-left-warning h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                            Available Slots
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ max_users - user_count }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-person-plus text-warning" style="font-size: 2rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card card-stats border-left-success h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Invitation Required
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            {% if require_invitation %}Yes{% else %}No{% endif %}
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-envelope text-success" style="font-size: 2rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Actions -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">Create New User</h6>
                            </div>
                            <div class="card-body">
                                <form method="post" action="/admin/users/create">
                                    <div class="mb-3">
                                        <label for="username" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="username" name="username" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="password" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="password" name="password" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-person-plus"></i> Create User
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">Create Invitation Code</h6>
                            </div>
                            <div class="card-body">
                                <form method="post" action="/admin/invitation-codes/create">
                                    <div class="mb-3">
                                        <label for="max_uses" class="form-label">Max Uses (optional)</label>
                                        <input type="number" class="form-control" id="max_uses" name="max_uses" min="1">
                                    </div>
                                    <div class="mb-3">
                                        <label for="expires_days" class="form-label">Expires in Days (optional)</label>
                                        <input type="number" class="form-control" id="expires_days" name="expires_days" min="1">
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-envelope-plus"></i> Create Code
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-danger">Change Admin Password</h6>
                            </div>
                            <div class="card-body">
                                <form method="post" action="/admin/change-password">
                                    <div class="mb-3">
                                        <label for="current_password" class="form-label">Current Password</label>
                                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="new_password" class="form-label">New Password</label>
                                        <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
                                        <div class="form-text">Password must be at least 6 characters long.</div>
                                    </div>
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to change your admin password?')">
                                        <i class="bi bi-key"></i> Change Password
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">All Users</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>User ID</th>
                                                <th>Username</th>
                                                <th>Created</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for user_item in users %}
                                            <tr>
                                                <td><code>{{ user_item.user_id[:8] }}...</code></td>
                                                <td>{{ user_item.username }}</td>
                                                <td>{{ user_item.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                                <td>
                                                    {% if user_item.is_active %}
                                                        <span class="badge bg-success">Active</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Inactive</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if user_item.is_active %}
                                                    <form method="post" action="/admin/users/{{ user_item.user_id }}/deactivate"
                                                          style="display: inline;"
                                                          onsubmit="return confirm('Are you sure you want to deactivate {{ user_item.username }}?')">
                                                        <button type="submit" class="btn btn-sm btn-danger">
                                                            <i class="bi bi-person-x"></i> Deactivate
                                                        </button>
                                                    </form>
                                                    {% else %}
                                                    <span class="text-muted">No actions available</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invitation Codes Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Invitation Codes</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Code</th>
                                                <th>Created By</th>
                                                <th>Created</th>
                                                <th>Expires</th>
                                                <th>Uses</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for code in invitation_codes %}
                                            <tr>
                                                <td><code>{{ code.code }}</code></td>
                                                <td>{{ code.created_by }}</td>
                                                <td>{{ code.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                                <td>
                                                    {% if code.expires_at %}
                                                        {{ code.expires_at.strftime('%Y-%m-%d %H:%M') }}
                                                    {% else %}
                                                        <span class="text-muted">Never</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {{ code.current_uses }}
                                                    {% if code.max_uses %}
                                                        / {{ code.max_uses }}
                                                    {% else %}
                                                        / ∞
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if code.is_active %}
                                                        <span class="badge bg-success">Active</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Inactive</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if code.is_active %}
                                                    <form method="post" action="/admin/invitation-codes/{{ code.code }}/deactivate"
                                                          style="display: inline;"
                                                          onsubmit="return confirm('Are you sure you want to deactivate this invitation code?')">
                                                        <button type="submit" class="btn btn-sm btn-danger">
                                                            <i class="bi bi-x-circle"></i> Deactivate
                                                        </button>
                                                    </form>
                                                    {% else %}
                                                    <span class="text-muted">No actions available</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Validate form before submission
document.querySelector('form[action="/admin/config"]').addEventListener('submit', function(e) {
    const percentages = document.getElementById('percentages').value;
    const thresholds = document.getElementById('thresholds').value;
    const lowThreshold = parseInt(document.getElementById('low_threshold').value);
    const highThreshold = parseInt(document.getElementById('high_threshold').value);
    const maxUsers = parseInt(document.getElementById('max_users').value);
    const aiBaseUrl = document.getElementById('ai_base_url').value.trim();
    const aiApiKey = document.getElementById('ai_api_key').value.trim();

    // Validate percentage format
    const percentageArray = percentages.split(',').map(p => parseFloat(p.trim()));
    if (percentageArray.some(p => isNaN(p) || p < 0 || p > 1)) {
        e.preventDefault();
        alert('Percentages must be numbers between 0 and 1');
        return;
    }

    // Validate threshold format
    const thresholdArray = thresholds.split(',').map(t => parseInt(t.trim()));
    if (thresholdArray.some(t => isNaN(t) || t <= 0)) {
        e.preventDefault();
        alert('Thresholds must be positive integers');
        return;
    }

    // Validate probability thresholds
    if (lowThreshold >= highThreshold) {
        e.preventDefault();
        alert('Low threshold must be less than high threshold');
        return;
    }

    // Validate max users
    if (isNaN(maxUsers) || maxUsers < 1 || maxUsers > 10000) {
        e.preventDefault();
        alert('Maximum users must be a number between 1 and 10000');
        return;
    }

    // Validate AI configuration
    if (!aiBaseUrl) {
        e.preventDefault();
        alert('AI Base URL is required');
        return;
    }

    if (!aiApiKey) {
        e.preventDefault();
        alert('AI API Key is required');
        return;
    }

    // Validate URL format
    try {
        new URL(aiBaseUrl);
    } catch (urlError) {
        e.preventDefault();
        alert('AI Base URL must be a valid URL');
        return;
    }
});
</script>
{% endblock %}
